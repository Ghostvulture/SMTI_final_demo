<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>二手交易平台</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<!-- 搜索栏子界面 -->
<div id="search" class="content page" data-parent="home">
    <button onclick="goBack()">返回</button>

    <!-- 搜索栏 -->
    <div class="search-bar">
        <input type="text" class="search-input" placeholder="搜索...">
    </div>
    <!-- 热榜 -->
    <div class="hotlist">
        <h2>热榜</h2>
        <div class="hot-item" onclick="filterPostsByTag('电子产品')">#电子产品</div>
        <div class="hot-item" onclick="filterPostsByTag('食品')">#食品</div>
        <div class="hot-item" onclick="filterPostsByTag('票务')">#票务</div>
    </div>
</div>

<!-- 首页 -->
<div id="home" class="content page">
    <!-- 搜索栏 -->
    <div class="search-bar">
        <input type="text" class="search-input" placeholder="搜索..." onclick="showPage('search')">
    </div>


    <!-- 新增按钮 -->
    <view class="button-container">
        <button class="tab-button active" onclick="showPage('home')">帖子</button>
        <button class="tab-button" onclick="showPage('store')">商店</button>
    </view>

    <!-- 标签区域 -->
    <div class="tags">
        <button class="tag-button" onclick="filterPostsByTag('电子产品')">#电子产品</button>
        <button class="tag-button" onclick="filterPostsByTag('食品')">#食品</button>
        <button class="tag-button" onclick="filterPostsByTag('书籍/资料')">#书籍/资料</button>
        <button class="tag-button" onclick="filterPostsByTag('交通工具')">#交通工具</button>
        <button class="tag-button" onclick="filterPostsByTag('生活用品')">#生活用品</button>
        <button class="tag-button" onclick="filterPostsByTag('票务')">#票务</button>
    </div>

    <!-- 帖子区域 -->
    <div class="posts">
        <div class="post" onclick="showPostDetail('post1')">
            <img src="https://www.w3schools.com/w3images/avatar2.png" class="avatar" alt="头像" onclick="goToChatChat('AAA老鼠药批发')">
            <div class="post-content">
                <div class="post-title">二手屏幕</div>
                <div class="post-body">去年双11买的，现在800出</div>
            </div>
            <div class="post-credits">
                <span>信誉评分: ${users['AAA老鼠药批发'].creditScore}</span> <!-- 显示信誉评分 -->
            </div>
        </div>
        <div class="post" onclick="showPostDetail('post2')">
            <img src="https://www.w3schools.com/w3images/avatar2.png" class="avatar" alt="头像" onclick="goToChat('绝赞泥头车')">
            <div class="post-content">
                <div class="post-title">出ipad pro 2018 11寸</div>
                <div class="post-body">64g，使用率低，打算出掉，...</div>
            </div>
            <div class="post-credits">
                <span>信誉评分: ${users['绝赞泥头车'].creditScore}</span> <!-- 显示信誉评分 -->
            </div>
        </div>
        <div class="post" onclick="showPostDetail('post3')">
            <img src="https://www.w3schools.com/w3images/avatar2.png" class="avatar" alt="头像" onclick="goToChat('我')">
            <div class="post-content">
                <div class="post-title">二手手机</div>
                <div class="post-body">最新款的手机，几乎全新，出手便宜。</div>
            </div>
            <div class="post-credits">
                <span>信誉评分: ${users['我'].creditScore}</span> <!-- 显示信誉评分 -->
            </div>
        </div>
    </div>

    <!-- 加号按钮 -->
    <button class="add-post-btn" onclick="showPage('create-post')">+</button>
</div>

<!-- 商店页面 -->
<div id="store" class="content page">
    <!-- 搜索栏 -->
    <div class="search-bar">
        <input type="text" class="search-input" placeholder="搜索..." onclick="showPage('search')">
    </div>

    <!-- 新增按钮 -->
    <view class="button-container">
        <button class="tab-button" onclick="showPage('home')">帖子</button>
        <button class="tab-button" onclick="showPage('store')">商店</button>
    </view>

    <!-- 标签区域 -->
    <div class="tags">
        <button class="tag-button" onclick="filterProductsByTag('创协')">#创协</button>
        <button class="tag-button" onclick="filterProductsByTag('学校')">#学校</button>
        <button class="tag-button" onclick="filterProductsByTag('INFO')">#INFO</button>
        <button class="tag-button" onclick="filterProductsByTag('SMMG')">#SMMG</button>
    </div>

    <!-- 价格过滤区域 -->
    <div class="price-filter">
        <button onclick="filterProductsByPrice(0, 100)">价格: 0 - 100</button>
        <button onclick="filterProductsByPrice(100, 200)">价格: 100 - 200</button>
        <button onclick="filterProductsByPrice(200, 300)">价格: 200 - 300</button>
        <button onclick="showAllProducts()">显示全部商品</button>
    </div>

    <!-- 商品区域 -->
    <div class="products">
        <!-- 商品将在这里动态渲染 -->
    </div>
</div>


<!-- 帖子详情 -->
<div id="post-detail" class="content page" data-parent="home">
    <button onclick="goBack()">返回</button>

    <div class="post-detail">
        <div class="post-header">
            <img src="pic_1.png" class="postAvatar" alt="头像" onclick="goToChat('AAA老鼠药批发')">
            <div>
                <div class="postTitle">二手屏幕</div>
                <div class="postAuthor">AAA屏幕批发</div>
            </div>
        </div>
        <div class="postBody">
            去年双11买的，现在800出  
        </div>
        <img src="https://via.placeholder.com/800x400" alt="帖子图片" class="postImage">
        
        <!-- 评论区 -->
        <div class="comments">
            <h3>评论区</h3>
            <div class="comment">
                <div class="comment-header">
                    <img src="https://www.w3schools.com/w3images/avatar2.png" class="comment-avatar" alt="头像">
                    <div class="comment-author">李四</div>
                </div>
                <div class="comment-body">
                    这是第一条评论的内容。可以是对帖子内容的讨论或者看法。
                </div>
            </div>
            <div class="comment">
                <div class="comment-header">
                    <img src="https://www.w3schools.com/w3images/avatar2.png" class="comment-avatar" alt="头像">
                    <div class="comment-author">绝赞泥头车</div>
                </div>
                <div class="comment-body">
                    这是第二条评论的内容。评论区展示用户对帖子内容的看法。
                </div>
            </div>
        </div>

        <!-- 发帖时间 -->
        <div class="postTimestamp" style="position: absolute; bottom: 10px; right: 10px; font-size: 12px; color: #777;">
            发布时间: 2024-11-29 10:00
        </div>
    </div>
</div>

<!-- 写帖子页面 -->
<div id="create-post" class="content page" data-parent="home">
    <button onclick="goBack()">返回</button>

    <h2>写帖子</h2>
    <div class="create-post-form">
        <!-- 标题输入框 -->
        <label for="postTitle">标题:</label>
        <input type="text" id="postTitle" placeholder="请输入标题" required>

        <!-- 内容输入框 -->
        <label for="postContent">内容:</label>
        <textarea id="postContent" placeholder="请输入内容" required></textarea>

        <!-- 上传图片 -->
        <label for="postImage">上传图片:</label>
        <input type="file" id="postImage" onchange="previewImage(event)">

        <!-- 标签选择 -->
        <label for="postTags">选择标签:</label>
        <select id="postTags">
            <option value="电子产品">电子产品</option>
            <option value="食品">食品</option>
            <option value="书籍/资料">书籍/资料</option>
            <option value="交通工具">交通工具</option>
            <option value="生活用品">生活用品</option>
            <option value="票务">票务</option>
        </select>

        <!-- 发布按钮 -->
        <button onclick="submitPost()">发布</button>
    </div>

    <!-- 图片预览 -->
    <div id="imagePreview" style="margin-top: 20px;"></div>
</div>


<!-- 存取界面 -->
<div id="storage" class="content page">
    <h2>存取界面</h2>
    <div class="store-option">
        <button onclick="showPage('transaction')">1. 存货/取货</button>
        <button onclick="showPage('history')">2. 历史记录</button>
    </div>
</div>

<!-- 存货/取货界面 -->
<div id="transaction" class="content page">
    <h2>存货/取货</h2>
    <div class="transaction-option">
        <label for="action">选择操作：</label>
        <select id="action" onchange="toggleTransactionOption()">
            <option value="store">存货</option>
            <option value="retrieve">取货</option>
        </select>

        <!-- 存货/取货详细信息 -->
        <div id="storeOption">
            <label for="orderSelect">选择已发起的订单：</label>
            <select id="orderSelect">
                <option value="order1">订单1</option>
                <option value="order2">订单2</option>
                <option value="order3">订单3</option>
            </select>

            <!-- 学校地图 -->
            <div id="map" style="width: 100%; height: 700px; margin-top: 10px; position: relative;">
                <!-- 使用简单的图片地图模拟 -->
                <img src="map.png" style="width: 100%; height: 100%; border: 2px solid #ccc;" alt="学校地图" id="campusMap">
                <div id="mapOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                    <!-- 存货柜子位置的按钮 -->
                    <button class="map-btn" style="position: absolute; top: 30%; left: 40%;" onclick="selectStorageSpot('柜子1')">柜子1</button>
                    <button class="map-btn" style="position: absolute; top: 60%; left: 50%;" onclick="selectStorageSpot('柜子2')">柜子2</button>
                    <button class="map-btn" style="position: absolute; top: 70%; left: 20%;" onclick="selectStorageSpot('柜子3')">柜子3</button>
                </div>
            </div>

            <!-- 生成确认码 -->
            <div id="storageCode" style="margin-top: 20px; display: block;">
                <label>存货确认码：</label>
                <input type="text" id="confirmCode" readonly>
                <button onclick="copyCode()">复制</button>
            </div>

            <!-- 确定按钮 -->
            <button id="confirmButton" onclick="generateConfirmationCode()">确定</button>

        </div>

        <!-- 取货操作 -->
        <div id="retrieveOption" style="display: none;">
            <label for="retrievalCode">请输入取件码：</label>
            <input type="text" id="retrievalCode" maxlength="4" placeholder="四位数取件码">
            <button onclick="retrieveItem()">确定</button>
            <div id="retrieveMessage" style="margin-top: 20px;"></div>
        </div>

    </div>
</div>


<!-- 历史记录界面 -->
<div id="history" class="content page">
    <h2>历史记录</h2>
    <ul class="history-list">
        <li class="history-item">
            <span>订单1</span>
            <span>进行中</span>
        </li>
        <li class="history-item">
            <span>订单2</span>
            <span>已结束</span>
        </li>
        <li class="history-item">
            <span>订单3</span>
            <span>进行中</span>
        </li>
    </ul>
</div>


<!-- 私聊历史联系人列表 -->
<div id="chat-list" class="content page">
    <h2>历史聊天</h2>
    <ul class="contact-list" id="contactList">
        <!-- 动态加载联系人列表 -->
    </ul>
</div>

<!-- 私聊页面 -->
<div id="chat" class="content page" data-parent="chat-list">
    <button onclick="goBack()">返回</button>

    <div class="chat-box" id="chatBox">
        <!-- 聊天内容 -->
    </div>

    <!-- 输入框 -->
    <div class="chat-input">
        <input type="text" id="chatInput" placeholder="请输入消息..." />
        <button onclick="sendMessage()">发送</button>

        <!-- 加号按钮 -->
        <button onclick="showOptionsMenu()">+</button>
    </div>

    <!-- 操作选择弹窗 -->
    <div id="optionsMenu" class="options-menu" style="display:none;">
        <ul>
            <li onclick="uploadFile()">上传文件</li>
            <li onclick="rateUser()">信用评分</li>
            <li onclick="quickBargain()">快速议价</li>
        </ul>
    </div>

    <!-- 快速议价弹窗 -->
    <div id="quickBargainWindow" class="quick-bargain-window" style="display:none;">
        <label for="bargainPrice">请输入议价价格：</label>
        <input type="number" id="bargainPrice" placeholder="请输入价格" />
        <button onclick="confirmBargain()">确认议价</button>
    </div>

    <!-- 交易结果显示 -->
    <div id="bargainResult"></div>

    <!-- 文件上传区域 -->
    <div class="preview" id="filePreview"></div>
</div>


<!-- 商店帖子详情页 -->
<div id="post-detail" class="content page" data-parent="store">
    <button onclick="goBack()">返回</button>

    <h2>商品详情</h2>
    <div class="post-detail-content">
        <img src="https://www.w3schools.com/w3images/avatar2.png" alt="头像" style="width: 50px; height: 50px; border-radius: 50%; margin-right: 15px;">
        <div class="post-detail-title">商品标题</div>
        <div class="post-detail-body">
            <p>商品详细描述，包含所有信息，用户可以在这里查看商品的详细内容。</p>
        </div>
    </div>
</div>

<!-- 个人界面 -->
<div id="profile" class="content page">
    <!-- 个人信息区 -->
    <div class="profile-info">
        <!-- 头像和昵称 -->
        <div class="profile-header">
            <img src="pic_3.png" alt="头像" class="profile-avatar">
            <div class="profile-details">
                <h2 class="profile-name">我</h2>
                <p class="profile-credit">信用评分: <span>4.5</span></p>  <!-- 信用评分 -->
            </div>
        </div>

        <!-- 个人简介 -->
        <div class="profile-bio">
            <p>自我介绍：一个好人</p>
        </div>

        <!-- 联系方式 -->
        <div class="contact-info">
            <p>联系方式：<span>微信：example_wechat</span></p>
            <p>Email：<span>example@email.com</span></p>
        </div>

        <!-- 交易信息 -->
        <div class="transaction-info">
            <p>交易成功：<span>50次</span></p>
            <p>成交总金额：<span>¥5000</span></p>
        </div>

        <!-- 我的需求功能 -->
        <div class="my-needs">
            <h3>我的需求</h3>
            <form id="need-form">
                <input type="text" id="user-demand" placeholder="请输入您的需求">
                <button onclick="saveUserDemand()">保存需求</button>
            </form>
            <p id="need-msg" class="need-msg"></p>
        </div>

        <!-- 完善个人信息按钮 -->
        <button class="btn-edit" onclick="showPage('payment-code')">完善个人信息</button>
    </div>
</div>

<!-- 收款码页面 -->
<div id="payment-code" class="content page" data-parent="profile">
    <button onclick="goBack()">返回</button>
    <h2>收款码</h2>
    <p>请上传您的收款码以便于交易</p>
    <!-- 输入框来上传收款码 -->
    <input type="file" id="paymentQrCode" accept="image/*">
    <div id="preview" style="margin-top: 10px;"></div>
</div>


<!-- 导航栏 -->
<nav>
    <a href="#" onclick="showPage('home')">首页</a>
    <a href="#" onclick="showPage('storage')">存取</a>
    <a href="#" onclick="showPage('chat-list')">私聊</a>
    <a href="#" onclick="showPage('profile')">个人</a>
</nav>

<!-- JavaScript -->
<script>

    let currentTagFilter = null; // 当前选中的标签，默认无过滤


    // 显示对应的页面
    function showPage(pageId) {
        // 隐藏所有页面
        const pages = document.querySelectorAll('.page');
        pages.forEach(page => page.style.display = 'none');



        // 显示对应的页面
        const activePage = document.getElementById(pageId);

        // 如果是首页，重置标签过滤器并刷新帖子列表
        if (pageId === 'home') {
            console.log('显示首页并清零');
            currentTagFilter = null;  // 重置标签过滤器
            // displayPosts();  // 刷新帖子列表，显示所有帖子
        }

        activePage.style.display = 'block';
    }

    // 默认显示首页
    showPage('home');

    // 用户与群聊数据库
    const users = {
        'AAA老鼠药批发': {
            nickname: 'AAA老鼠药批发',
            avatar: 'pic_1.png',
            creditScore: 90,
            posts: ['post1'] // AAA老鼠药批发的发帖记录
        },
        '绝赞泥头车': {
            nickname: '绝赞泥头车',
            avatar: 'pic_2.png',
            creditScore: 80,
            posts: ['post2'] // 绝赞泥头车的发帖记录
        },
        '我': {
            nickname: '我',
            avatar: 'pic_3.png',
            creditScore: 85,
            posts: ['post1'] // 我的发帖记录
        },
        '拼单群': {
            nickname: '拼单群',
            avatar: 'https://www.w3schools.com/w3images/avatar2.png'
        }
    };

    // 发帖记录
    const posts = {
        'post1': {
            id: 1,
            title: '老鼠药出售',
            author: 'AAA老鼠药批发',
            content: '去年双11买的，现在800出',
            timestamp: '2024-11-29 10:00',
            image:'pic_1.png',
            tag: '食品',
            comments: [
                { author: '我', content: '呃这真的允许卖吗', avatar: 'pic_3.png'},
                { author: '绝赞泥头车', content: '挺不错的，值得考虑。', avatar: 'pic_2.png'}
            ]
        },
        'post2': {
            id: 2,
            title: '出ipad pro 2018 11寸',
            author: '绝赞泥头车',
            content: '64g，使用率低，打算出掉，...',
            timestamp: '2024-11-28 15:00',
            image:'pic_2.png',
            tag: '电子产品',
            comments: [
                { author: '绝赞泥头车', content: '有需要的联系我，价格可以谈。', avatar: 'pic_2.png'}
            ]
        },
        'post3': {
            id: 3,
            title: '绝赞铲子转让',
            author: '我',
            content: '只埋了一次，5成新，期待出售，不接受砍价，谢谢',
            timestamp: '2024-11-29 11:00',
            image:'pic_3.png',
            tag: '生活用品',
            comments: [
                { author: '我', content: '把这个东西卖掉也太抽象了', avatar: 'pic_3.png'}
            ]
        },
        'post4': {
            id: 4,
            title: 'tb47电池拼单',
            author: '我',
            content: '二手tb47电池一块50，一块使用两次就能扔，有需要的联系我。型号：8.4V 400mAh锂电池；12.6V 300mAh锂电池；3.7V 1200mAh锂电池',
            timestamp: '2024-10-29 11:00',
            image:'tb47.png',
            tag: '交通工具',
            comments: [
                { author: 'AAA老鼠药批发', content: '666666666666', avatar: 'pic_1.png'}
            ]
        }
    };

    // 模拟的聊天数据库
    const chatDatabase = {
        'AAA老鼠药批发': [
            { sender: '我', content: '请问老鼠药的真实成分是什么？', timestamp: '2024-11-29 09:00' },
            { sender: 'AAA老鼠药批发', content: '乌龙茶', timestamp: '2024-11-29 09:01' },
            { sender: '我', content: '额疑似虚假宣传哈', timestamp: '2024-11-29 09:03' }

        ],
        '绝赞泥头车': [
            { sender: '我', content: '你这商品看起来最正常', timestamp: '2024-11-29 08:30' },
            { sender: '绝赞泥头车', content: '其实AAA老鼠药批发是我小号', timestamp: '2024-11-29 08:35' },
            { sender: '我', content: '这下不得不买了，请放菜鸟驿站处柜子', timestamp: '2024-11-29 08:40' },
            { sender: '绝赞泥头车', content: '取件码4098', timestamp: '2024-11-29 08:50' }

        ],
        '拼单群': [
            { sender: '我', content: '快来买绝赞鼓包电池～', timestamp: '2024-11-29 07:00' },
            { sender: 'AAA老鼠药批发', content: '选A来30套，请发收款码', timestamp: '2024-11-29 07:05' },
            { sender: '绝赞泥头车', content: '未付款，期待发货', timestamp: '2024-11-29 07:10' }
        ]
    };
    
    //商店商品
    const products = [
    {
        name: '信小鹰',
        category: 'INFO',
        description: '来自info',
        price: 120,  // 商品价格
        image: 'eagle.png'
    },
    {
        name: '红鸟',
        category: '学校',
        description: '红火火',
        price: 250,  // 商品价格
        image: 'red_bird.png'
    },
    {
        name: '塔塔',
        category: '创协',
        description: '来自创协',
        price: 80,  // 商品价格
        image: 'tata_pic.png'
    },
    {
        name: '章鱼',
        category: 'SMMG',
        description: '来自SMMG',
        price: 280,  // 商品价格
        image: 'SMMG_oct.jpg'
    }
];

    // 更新联系人列表
    function updateContactList() {
        const contactListContainer = document.getElementById('contactList');
        contactListContainer.innerHTML = ''; // 清空当前列表

        // 遍历聊天数据库，生成联系人列表
        for (const contact in chatDatabase) {
            const lastMessage = chatDatabase[contact][chatDatabase[contact].length - 1];
            const contactItem = document.createElement('li');
            contactItem.classList.add('contact-item');
            contactItem.onclick = () => goToChat(contact);

            // 创建联系人项
            contactItem.innerHTML = `
                <img src="${users[contact].avatar}" alt="头像">
                <div>
                    <div class="name">${users[contact].nickname}</div>
                    <div class="last-message">${lastMessage.content}</div>
                    <div class="credit-score">信誉评分: ${users[contact].creditScore}</div> <!-- 显示信誉评分 -->
                </div>
            `;

            // 将联系人项添加到列表中
            contactListContainer.appendChild(contactItem);
        }
    }

    // 显示操作选择菜单
    function showOptionsMenu() {
        const optionsMenu  = document.getElementById('optionsMenu');
        optionsMenu.style.display = optionsMenu.style.display === 'none' ? 'block' : 'none';
    }

    // 上传文件功能
    function uploadFile() {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = 'image/*, application/pdf, .docx, .txt';
        fileInput.onchange = function (event) {
            const file = event.target.files[0];
            if (file) {
                const preview = document.getElementById('filePreview');
                const reader = new FileReader();

                reader.onload = function(e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    preview.innerHTML = ''; // 清空之前的预览
                    preview.appendChild(img); // 显示预览
                };

                reader.readAsDataURL(file); // 读取文件
            }
        };
        fileInput.click(); // 触发文件选择
    }

    // 给对方打分功能
    function rateUser() {
        const targetUser = prompt('请输入你想评分的用户昵称：');
        if (!targetUser || !users[targetUser]) {
            alert('无效的用户！');
            return;
        }

        const rating = prompt('请输入评分（1 - 100）：');
        const numericRating = parseInt(rating);

        if (isNaN(numericRating) || numericRating < 1 || numericRating > 100) {
            alert('评分无效，请输入1到100之间的数字。');
            return;
        }

        // 更新目标用户的信用评分
        const oldCredit = users[targetUser].creditScore;
        const newCredit = (oldCredit + numericRating) / 2; // 新评分计算方式
        users[targetUser].creditScore = newCredit;

        alert(`已成功给 ${targetUser} 打分，新的信用评分是：${newCredit}`);
        updateContactList(); // 更新联系人列表
    }

    function quickBargain() {
        const quickBargainWindow = document.getElementById('quickBargainWindow');
        quickBargainWindow.style.display = 'block';
    }

    // 确认议价
    function confirmBargain() {
        const bargainPrice = document.getElementById('bargainPrice').value;
        const bargainResult = document.getElementById('bargainResult');

        if (bargainPrice) {
            const userResponse = prompt('对方是否同意？输入1表示同意，输入2表示不同意');
            if (userResponse === '1') {
                console.log(1);
                bargainResult.textContent = `价格已修改为: ${bargainPrice}元，交易已确认。`;
            } else if (userResponse === '2') {
                console.log(2);
                bargainResult.textContent = '对方不同意修改价格。';
            } else {
                bargainResult.textContent = '输入无效，请输入1或2。';
            }
        } else {
            bargainResult.textContent = '请输入有效的议价价格。';
        }

        // 关闭议价窗口
        document.getElementById('quickBargainWindow').style.display = 'none';
    }
    
    // 存储用户需求到本地
    let userDemand = '';  // 默认没有需求

    function saveUserDemand() {
        userDemand = document.getElementById('user-demand').value.trim();
        alert('您的需求已保存！');
        // 你可以将用户需求保存到localStorage或者服务器
        console.log('用户需求：', userDemand);
        localStorage.setItem('userDemand', userDemand);  // 将需求存储到localStorage
    }

    // 显示私聊记录
    function goToChat(contactName) {
        showPage('chat');
        const chatBox = document.getElementById('chatBox');
        chatBox.innerHTML = '';  // 清空聊天框

        // 获取该联系人的聊天记录
        const messages = chatDatabase[contactName];
        messages.forEach(message => {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.innerHTML = `
                <div class="sender">${message.sender}</div>
                <div class="content">${message.content}</div>
            `;
            chatBox.appendChild(messageElement);
        });

        // 获取用户的需求
        const userDemand = localStorage.getItem('userDemand') || '';  // 从localStorage获取需求

        if (userDemand) {
            // 如果用户有需求，搜索帖子数据库并匹配标题
            const matchedPosts = Object.values(posts).filter(post =>
                post.title.includes(userDemand)  // 标题包含需求内容
            );

            if (matchedPosts.length > 0 & userDemand) {
                // 如果找到匹配的帖子且需求不为空，自动发送消息给用户
                const matchedPost = matchedPosts[0];  // 只取第一个匹配的帖子
                const message = `找到这条新帖子可能满足您的需求：\n${matchedPost.title} \n点击链接查看详情：${window.location.origin}/post/${matchedPost.id}`;
                chatBox.innerHTML += `
                    <div class="message">
                        <div class="sender">交易小助手机器人</div>
                        <div class="content">${message}</div>
                    </div>
                `;
            } else {
                chatBox.innerHTML += `
                    <div class="message">
                        <div class="sender">交易小助手机器人</div>
                        <div class="content">暂时没有找到符合您需求的帖子哦！</div>
                    </div>
                `;
            }
    }

    // 自动滚动到最新消息
    chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 初始化时更新联系人列表
    updateContactList();


    // 发送消息
    function sendMessage() {
        const chatInput = document.getElementById('chatInput');
        const message = chatInput.value.trim();
        if (message) {
            const chatBox = document.getElementById('chatBox');
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.innerHTML = `
                <div class="sender">我</div>
                <div class="content">${message}</div>
            `;
            chatBox.appendChild(messageElement);
            chatInput.value = '';  // 清空输入框
            chatBox.scrollTop = chatBox.scrollHeight;  // 滚动到最新消息
        }
    }

    // 预览上传的文件
    function previewFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        const preview = document.getElementById('filePreview');
        preview.innerHTML = '';

        if (file) {
            const fileReader = new FileReader();
            fileReader.onload = function (e) {
                const fileType = file.type.split('/')[0];
                if (fileType === 'image') {
                    preview.innerHTML = `<img src="${e.target.result}" alt="预览图片">`;
                } else if (fileType === 'video') {
                    preview.innerHTML = `<video controls><source src="${e.target.result}" type="${file.type}"></video>`;
                }
            };
            fileReader.readAsDataURL(file);
        }
    }


    // 过滤帖子，根据选择的标签来显示
    function filterPostsByTag(tag) {
        console.log(currentTagFilter);
        if (currentTagFilter === tag) {
        // 如果当前标签已经被选中，再次点击时显示所有帖子
            currentTagFilter = null;
        } else {
            // 否则，设置为点击的标签
            currentTagFilter = tag;
        }
        // // 显示首页并重新渲染帖子
        // showPage('home');
        displayPosts(); // 重新渲染帖子
    }

    // 更新帖子列表显示
    function displayPosts() {
        const postsContainer = document.querySelector('.posts');
        postsContainer.innerHTML = ''; // 清空当前帖子列表

        Object.keys(posts).forEach(postId => {
            const post = posts[postId];

            // 如果有标签过滤且帖子的标签不匹配，则跳过
            if (currentTagFilter && post.tag !== currentTagFilter) {
                return;
            }

            const postElement = document.createElement('div');
            postElement.classList.add('post');
            postElement.onclick = () => showPostDetail(postId);

            console.log(post.author);

            postElement.innerHTML = `
                <img src="${users[post.author].avatar}" class="avatar" alt="头像" onclick="goToChat('${post.author}')">
                <div class="post-content">
                    <div class="post-title">${post.title}</div>
                    <div class="post-body">${post.content}</div>
                    <div class="post-tag">tag: #${post.tag}</div>
                    <div class="post-time">${post.timestamp}</div>
                </div>
            `;
            postsContainer.appendChild(postElement);
        });
    }

    // 显示帖子详情
    function showPostDetail(postId) {
        const post = posts[postId];
        showPage('post-detail');

        // 更新帖子信息
        document.querySelector('.postTitle').textContent = post.title;
        document.querySelector('.postAuthor').textContent = post.author;
        document.querySelector('.postBody').textContent = post.content;
        document.querySelector('.postTimestamp').textContent = `发布时间: ${post.timestamp}`;
        document.querySelector('.postImage').src = post.image || 'https://via.placeholder.com/800x400';
        document.querySelector('.postAvatar').src = users[post.author].avatar;

        // 更新评论区
        const commentsSection = document.querySelector('.comments');
        commentsSection.innerHTML = '<h3>评论区</h3>';  // 重置评论区标题

        // 填充评论
        post.comments.forEach(comment => {
            commentsSection.innerHTML += `
                <div class="comment">
                    <div class="comment-header">
                        <img src="${comment.avatar}" class="comment-avatar" alt="头像">
                        <div class="comment-author">${comment.author}</div>
                    </div>
                    <div class="comment-body">${comment.content}</div>
                </div>
            `;
        });
    }
    
    // 返回到上一页面
    function goBack() {
        const activePage = document.querySelector('.page[style="display: block;"]'); // 当前显示的页面
        if (activePage) {
            const parentPageId = activePage.getAttribute('data-parent'); // 获取父界面 ID
            if (parentPageId) {
                showPage(parentPageId); // 显示父界面
            }
        }
    }

    // 发布帖子
    function submitPost() {
        const title = document.getElementById('postTitle').value;
        const content = document.getElementById('postContent').value;
        const image = document.getElementById('postImage').files[0];
        const tag = document.getElementById('postTags').value;

        // console.log(title, content, image, tag);

        if (!title || !content) {
            alert("标题和内容不能为空！");
            return;
        }

        // 上传图片并获取图片URL
        let imageUrl = '';
        if (image) {
            const reader = new FileReader();
            reader.onload = function(e) {
                imageUrl = e.target.result;
                createPost(title, content, imageUrl, tag);
            };
            reader.readAsDataURL(image);
        } else {
            createPost(title, content, imageUrl, tag);
        }
    }

    // 创建帖子并添加到首页
    function createPost(title, content, imageUrl, tag) {
        const postId = `post${Date.now()}`; // 使用时间戳生成唯一的帖子ID
        const post = {
            title: title,
            author: '我',
            content: content,
            image: imageUrl,
            tag: tag,
            timestamp: new Date().toLocaleString(),
            comments: []
        };

        // 添加到帖子对象
        posts[postId] = post;

        // 在首页显示新的帖子
        displayPosts();

        // 返回首页
        showPage('home');
    }

    // 图片预览
    function previewImage(event) {
        const file = event.target.files[0];
        const preview = document.getElementById('imagePreview');
        preview.innerHTML = '';  // 清除之前的预览

        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.innerHTML = `<img src="${e.target.result}" alt="预览图片" style="max-width: 100%;">`;
            };
            reader.readAsDataURL(file);
        }
    }


    // 初始化首页显示帖子
    displayPosts();

    let selectedStorageSpot = ''; // 存储选中的存货柜子

    // 显示存货/取货详细信息
    function toggleTransactionOption() {
        const action = document.getElementById('action').value;
        const storeOption = document.getElementById('storeOption');
        const retrieveOption = document.getElementById('retrieveOption');
        const storageCode = document.getElementById('storageCode');

        if (action === 'store') {
            storeOption.style.display = 'block';
            retrieveOption.style.display = 'none';
            storageCode.style.display = 'none'; // 隐藏存货确认码
        } else if (action === 'retrieve') {
            storeOption.style.display = 'none';
            retrieveOption.style.display = 'block';
            storageCode.style.display = 'none'; // 隐藏存货确认码
        }
    }

    // 选择存货柜子并生成确认码
    function selectStorageSpot(spot) {
        selectedStorageSpot = spot;
        alert('选中了 ' + spot + '。请选择订单并点击确认生成确认码。');
        console.log(selectedStorageSpot);
    }

    // 确认操作，生成4位随机确认码
    function generateConfirmationCode() {
        if (!selectedStorageSpot) {
            alert('请先选择存货柜子！');
            return;
        }

        // 生成4位随机数字
        const confirmCode = Math.floor(1000 + Math.random() * 9000);
        document.getElementById('confirmCode').value = confirmCode;

        // 显示确认码输入框
        document.getElementById('storageCode').style.display = 'block';
    }

    // 复制确认码
    function copyCode() {
        const confirmCodeInput = document.getElementById('confirmCode');
        confirmCodeInput.select();
        document.execCommand('copy');
        alert('确认码已复制！');
    }

    // 取货操作
    function retrieveItem() {
        const retrievalCode = document.getElementById('retrievalCode').value;
        const retrieveMessage = document.getElementById('retrieveMessage');
        
        if (retrievalCode.length === 4 && !isNaN(retrievalCode)) {
            retrieveMessage.textContent = '开柜成功！';
            retrieveMessage.style.color = 'green';
        } else {
            retrieveMessage.textContent = '请输入有效的四位取件码！';
            retrieveMessage.style.color = 'red';
        }
    }

    let currentPriceFilter = null;  // 当前的价格过滤
    let currentProductTagFilter = null;  // 当前的标签过滤

    // 过滤不同学域的商品
    function filterProductsByTag(tag) {
        if (currentProductTagFilter === tag) {
            // 如果当前标签已经被选中，再次点击时显示所有帖子
            currentProductTagFilter = null;
        } else {
            // 否则，设置为点击的标签
            currentProductTagFilter = tag;
        }

        displayProducts(); // 重新渲染帖子
    }
    
    // 过滤价格范围的函数
    function filterProductsByPrice(min, max) {
        currentPriceFilter = { min, max };  // 设置当前的价格过滤范围
        displayProducts();  // 重新渲染商品列表
    }

    // 显示所有商品
    function showAllProducts() {
        currentPriceFilter = null;  // 清空价格过滤
        currentProductTagFilter = null;  // 清空标签过滤
        displayProducts();  // 重新渲染商品列表
    }

    // 更新商品显示
    function displayProducts() {
        const productsContainer = document.querySelector('.products');
        productsContainer.innerHTML = '';  // 清空当前商品列表

        const filteredProducts = products.filter(product => {
            // 如果有标签过滤，检查商品是否匹配标签
            if (currentProductTagFilter && product.category !== currentProductTagFilter) {
                return false;  // 不符合标签过滤条件的商品被过滤掉
            }

            // 如果有价格过滤，检查商品的价格是否在范围内
            if (currentPriceFilter && (product.price < currentPriceFilter.min || product.price > currentPriceFilter.max)) {
                return false;  // 不符合价格过滤条件的商品被过滤掉
            }
            return true;  // 没有过滤时，显示所有商品
        });

        // 渲染商品
        filteredProducts.forEach(product => {
            const productElement = document.createElement('div');
            productElement.classList.add('product');

            productElement.innerHTML = `
                <img src="${product.image}" class="avatar" alt="头像">
                <div class="product-content">
                    <div class="product-title">${product.name}</div>
                    <div class="product-body">${product.description}</div>
                    <div class="product-price">价格: ¥${product.price}</div>
                </div>
                <button class="buy-button" onclick="buyProduct('${product.name}')">购买</button>
            `;

            productsContainer.appendChild(productElement);
        });
    }


    // 处理购买操作
    function buyProduct(productName) {
        alert(`您已购买: ${productName}`);
    }


    
    // 保存个人信息
    function saveProfile() {
        const paymentCode = document.getElementById('paymentCode').value;
        alert('个人信息已保存：' + paymentCode);
        showPage('profile');
    }
    


    // 默认加载时显示存货选项
    toggleTransactionOption();



</script>

</body>
</html>
